<!DOCTYPE html>
<html>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
<script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"> </script>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>canvas</title>
	<style type="text/css">
		html,body{
			height: 100%;
			padding: 0px;
			margin:  0px;
		}
	</style>

	<script>
    async function loadModel() {
      model = undefined;
			url = "https://raw.githubusercontent.com/SXCSEM6-project/ModelStore/main/model.json"
      model = await tf.loadLayersModel(url);
      console.log("model loaded")
			//console.log(model.summary())
    }
		loadModel()


	</script>
</head>
<body>
	<br><br><br><br>
	<center><canvas width="64" height="64" id="c" style="border: 2px solid black;" align="center">
		</canvas>

		<br><button onclick="read(); convert();">CLICK</button>
		<br><br><button onclick="clrCnv()">CLEAR</button>
		<br><br>
	</center>
	<script type="text/javascript">
		const canvas = document.getElementById("c");
		const context = canvas.getContext("2d");
		context.fillStyle = "white";
		context.lineWidth = 5;
		context.fillRect(0, 0, canvas.width, canvas.height);
		canvas.addEventListener("mousedown", (event)=>{
			context.beginPath();
			context.moveTo(event.offsetX, event.offsetY);
			canvas.addEventListener("mousemove",draw,false)
		}, false)
		canvas.addEventListener("mouseup", (event)=>{
			canvas.removeEventListener("mousemove",draw,false);
		}, false);

		document.body.addEventListener("mouseup", (event)=>{
			canvas.removeEventListener("mousemove",draw,false);
		}, false);

		const draw = function(event){
			context.lineTo(event.offsetX, event.offsetY);
			context.moveTo(event.offsetX, event.offsetY);
			context.stroke();
		}

		function read()
		{
			img = tf.browser.fromPixels(canvas, 1) // reads image from canvas
			pred = tf.tensor( [ img.arraySync() ] )
			pred = tf.scalar(255).sub(img)
			pred = pred.div(tf.scalar(255))
			v = model.predict( tf.tensor( [ pred.arraySync() ] ) )
			res = tf.tensor( v.dataSync() ).argMax().dataSync()
			console.log( res[0] )
			tf.browser.toPixels(pred,canvas) // prints read image to canvas
			// console.log( tf.tensor( [ pred.arraySync() ] ) )
		}

		function clrCnv()
		{
			context.clearRect(0, 0, canvas.width, canvas.height);
			context.fillStyle = "white";
			context.lineWidth = 5;
			context.fillRect(0, 0, canvas.width, canvas.height);
		}

		const convert = function(){
			let png = canvas.toDataURL("image/png")
			var msg = JSON.stringify(png);
			console.log(msg)
   			var xhr = new XMLHttpRequest();
   			xhr.open('POST',"/convert",true);
   			xhr.send(msg);
   			alert('file is saved');
		}
	</script>
</body>
</html>
